<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Hauyna Chat Avanzado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fuente opcional -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #7C3AED;
      --primary-light: #8B5CF6;
      --primary-dark: #6D28D9;
      --secondary-color: #F3F4F6;
      --text-primary: #1F2937;
      --text-secondary: #6B7280;
      --success-color: #10B981;
      --error-color: #EF4444;
      --border-radius: 12px;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
    }
    .chat-container {
      width: 100%;
      height: 100vh;
      background: #fff;
      display: grid;
      grid-template-rows: auto auto auto 1fr;
      overflow: hidden;
    }
    .chat-header {
      background: var(--primary-color);
      color: white;
      padding: 20px;
      position: relative;
      text-align: center;
    }
    .chat-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    .toggle-users {
      display: none;
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .connection-status {
      text-align: center;
      padding: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      background: var(--secondary-color);
    }
    .connection-status.connected {
      color: var(--success-color);
    }
    .connection-status.disconnected {
      color: var(--error-color);
    }
    .rooms {
      display: flex;
      gap: 10px;
      padding: 10px 15px;
      background: white;
      border-bottom: 1px solid #E5E7EB;
      overflow-x: auto;
    }
    .rooms button {
      padding: 8px 16px;
      border: 1px solid var(--primary-color);
      border-radius: 20px;
      background: transparent;
      color: var(--primary-color);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 500;
      white-space: nowrap;
    }
    .rooms button:hover {
      background: var(--primary-color);
      color: #fff;
    }
    .rooms button.active {
      background: var(--primary-color);
      color: #fff;
    }
    .unread-count {
      background-color: var(--error-color);
      color: white;
      border-radius: 12px;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      font-size: 0.75rem;
      font-weight: bold;
      display: none;
      align-items: center;
      justify-content: center;
      margin-left: 5px;
    }
    .unread-count:not(:empty) {
      display: inline-flex;
    }
    .error-message {
      background: #FEE2E2;
      color: var(--error-color);
      padding: 12px;
      margin: 10px;
      border-radius: var(--border-radius);
      font-size: 0.875rem;
      display: none;
    }
    .chat-layout {
      display: grid;
      grid-template-columns: 250px 1fr;
      height: 100%;
      overflow: hidden;
    }
    .users-panel {
      background: #fff;
      border-right: 1px solid #E5E7EB;
      display: flex;
      flex-direction: column;
    }
    .users-header {
      padding: 15px;
      background: var(--secondary-color);
      border-bottom: 1px solid #E5E7EB;
      font-weight: 500;
    }
    .users-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .user-item {
      padding: 10px;
      margin: 5px 0;
      border-radius: var(--border-radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    .user-item:hover {
      background: var(--secondary-color);
    }
    .user-item.selected {
      background: var(--primary-color);
      color: #fff;
    }
    .user-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success-color);
    }
    @media (max-width: 768px) {
      .chat-layout {
        grid-template-columns: 1fr;
      }
      .users-panel {
        display: none;
      }
      .users-panel.active {
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 250px;
        z-index: 10;
      }
      .toggle-users {
        display: block !important;
      }
    }
    .chat-main {
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    .chat-content {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }
    .chat-content.active {
      display: flex;
    }
    .chat-messages {
      padding: 10px 20px;
      overflow-y: scroll;
      background: #FAFAFA;
      flex: 1;
      min-height: 0;
    }
    .message-container {
      display: flex;
      flex-direction: column;
    }
    .message {
      margin-bottom: 20px;
      max-width: 80%;
      display: flex;
      flex-direction: column;
      gap: 4px;
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .message.received { margin-right: auto; }
    .message.sent { margin-left: auto; }
    .message .user {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    .message .content {
      padding: 12px 16px;
      border-radius: 16px;
      word-wrap: break-word;
    }
    .message.received .content {
      background: #fff;
      border: 1px solid #E5E7EB;
      border-bottom-left-radius: 4px;
    }
    .message.sent .content {
      background: var(--primary-color);
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .message .time {
      font-size: 0.75rem;
      color: var(--text-secondary);
      align-self: flex-end;
    }
    .private-message {
      position: relative;
    }
    .private-message::before {
      content: 'üîí';
      position: absolute;
      top: -15px;
      left: 5px;
      font-size: 12px;
    }
    .private-message .content {
      background: #E0F2FE;
      color: #0C4A6E;
      border: 1px solid #BAE6FD;
    }
    .system-message {
      text-align: center;
      color: var(--text-secondary);
      margin: 5px 0 15px 0;
      font-size: 0.875rem;
      padding: 8px;
      background: var(--secondary-color);
      border-radius: var(--border-radius);
    }
    .chat-input {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      padding: 20px;
      background: #fff;
      border-top: 1px solid #E5E7EB;
      position: sticky;
      bottom: 0;
    }
    .chat-input input {
      padding: 12px;
      border: 1px solid #E5E7EB;
      border-radius: var(--border-radius);
      font-size: 0.875rem;
    }
    .chat-input input:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    .chat-input button {
      padding: 12px 24px;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 500;
      cursor: pointer;
    }
    .chat-input button:hover {
      background: var(--primary-dark);
    }
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(209, 213, 219, 0.5);
      border-radius: 4px;
      transition: background 0.2s;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(156, 163, 175, 0.8);
    }
    .message .content a {
      color: inherit;
      text-decoration: underline;
    }
    .message.received .content a {
      color: var(--primary-color);
    }
    .unread-badge {
      background-color: var(--error-color);
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      font-weight: bold;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .unread-count.pulse {
      animation: pulse 0.5s ease-in-out;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <button class="toggle-users">‚ò∞</button>
      <h2>Hauyna Chat</h2>
    </div>

    <div class="connection-status">Conectando...</div>

    <div class="rooms">
      <button onclick="changeRoom('lobby')" class="active" data-room="lobby">
        üè† Lobby <span class="unread-count" id="unread-lobby"></span>
      </button>
      <button onclick="changeRoom('general')" data-room="general">
        üí¨ General <span class="unread-count" id="unread-general"></span>
      </button>
      <button onclick="changeRoom('soporte')" data-room="soporte">
        üõü Soporte <span class="unread-count" id="unread-soporte"></span>
      </button>
      <button onclick="changeRoom('casual')" data-room="casual">
        üéÆ Casual <span class="unread-count" id="unread-casual"></span>
      </button>
      <button onclick="changeRoom('tech')" data-room="tech">
        üíª Tech <span class="unread-count" id="unread-tech"></span>
      </button>
    </div>

    <div class="error-message"></div>

    <div class="chat-layout">
      <div class="users-panel">
        <div class="users-header">Usuarios Conectados</div>
        <div class="users-list"><!-- Se llena din√°micamente --></div>
      </div>

      <div class="chat-main">
        <div class="chat-input">
          <input type="text" id="messageInput" placeholder="Escribe tu mensaje aqu√≠...">
          <button id="sendButton">Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    class AdvancedChatClient {
      constructor() {
        const alias = prompt("¬øCu√°l es tu nombre o alias?");
        this.userId = alias && alias.trim() ? alias.trim() : 'user_' + Math.random().toString(36).substr(2, 9);

        this.room = 'lobby';
        this.selectedUser = null;
        this.connectedUsers = new Set();

        this.chatHistory = new Map();

        this.roomConfig = {
          'lobby':   { emoji: 'üè†', name: 'Lobby' },
          'general': { emoji: 'üí¨', name: 'General' },
          'soporte': { emoji: 'üõü', name: 'Soporte' },
          'casual':  { emoji: 'üéÆ', name: 'Casual' },
          'tech':    { emoji: 'üíª', name: 'Tech' }
        };
        this.availableRooms = Object.keys(this.roomConfig);

        this.unreadCounts = this.availableRooms.reduce((acc, room) => {
          acc[room] = 0;
          return acc;
        }, { private: new Map() });

        this.activeRoom = 'lobby';

        if ("Notification" in window && Notification.permission === "default") {
          Notification.requestPermission();
        }

        this.setupElements();
        this.setupWebSocket();
        this.setupEventListeners();
        this.initializeUnreadCounters();

        this.switchToChat('lobby');
      }

      setupElements() {
        this.connectionStatus = document.querySelector('.connection-status');
        this.errorMessage     = document.querySelector('.error-message');
        this.toggleUsers      = document.querySelector('.toggle-users');
        this.usersPanel       = document.querySelector('.users-panel');
        this.usersList        = document.querySelector('.users-list');
        this.chatMain         = document.querySelector('.chat-main');
        this.messageInput     = document.getElementById('messageInput');
        this.sendButton       = document.getElementById('sendButton');
      }

      setupWebSocket() {
        if (!this.reconnectAttempts) this.reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const RECONNECT_DELAY = 3000;

        try {
          this.connectionStatus.textContent = 'Intentando conectar...';

          const WS_PORT = 3000;
          const WS_HOST = 'localhost';
          const wsUrl = `ws://${WS_HOST}:${WS_PORT}/chat?user_id=${encodeURIComponent(this.userId)}&room=${this.room}`;

          console.log('Intentando conectar a:', wsUrl);

          this.ws = new WebSocket(wsUrl);
          this.wsReady = false;

          const connectionTimeout = setTimeout(() => {
            if (!this.wsReady) {
              console.log('Timeout de conexi√≥n');
              this.ws.close();
            }
          }, 5000);

          this.ws.onopen = () => {
            clearTimeout(connectionTimeout);
            this.reconnectAttempts = 0;
            setTimeout(() => {
              this.wsReady = true;
              this.handleOpen();
              this.joinRoom(this.room);
            }, 100);
          };

          this.ws.onclose = (event) => {
            clearTimeout(connectionTimeout);
            this.wsReady = false;
            this.handleClose(event);
            console.log('Conexi√≥n cerrada. C√≥digo:', event.code, 'Raz√≥n:', event.reason);

            if (event.code !== 1000 && this.reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
              this.reconnectAttempts++;
              this.connectionStatus.textContent =
                `Desconectado - Reconectando (intento ${this.reconnectAttempts} de ${MAX_RECONNECT_ATTEMPTS})...`;
              setTimeout(() => this.setupWebSocket(), RECONNECT_DELAY * this.reconnectAttempts);
            } else if (this.reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
              this.connectionStatus.textContent =
                'No se pudo conectar al servidor. Verifica tu conexi√≥n y recarga la p√°gina.';
              this.showError('Error de conexi√≥n: No se pudo establecer comunicaci√≥n con el servidor');
            }
          };

          this.ws.onerror = (error) => {
            this.wsReady = false;
            console.error('Error de WebSocket:', error);
            if (!this.wsReady) {
              this.showError('No se pudo conectar al servidor de chat. Verificando conexi√≥n...');
            } else {
              this.showError('Se perdi√≥ la conexi√≥n con el servidor');
            }
            this.handleError();
          };

          this.ws.onmessage = this.handleMessage.bind(this);

        } catch (error) {
          console.error('Error al configurar WebSocket:', error);
          this.showError('Error al inicializar la conexi√≥n');
          if (this.reconnectAttempts < 5) {
            setTimeout(() => this.setupWebSocket(), 3000);
          }
        }
      }

      setupEventListeners() {
        this.sendButton.onclick = () => this.sendMessage();
        this.messageInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            this.sendMessage();
          }
        });
        this.toggleUsers?.addEventListener('click', () => {
          this.usersPanel.classList.toggle('active');
        });
      }

      createChatContent(chatId) {
        const content = document.createElement('div');
        content.className = 'chat-content';
        content.id = `chat-${chatId}`;

        const messages = document.createElement('div');
        messages.className = 'chat-messages';

        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
        messages.appendChild(messageContainer);

        content.appendChild(messages);
        return content;
      }

      switchToChat(chatId) {
        document.querySelectorAll('.chat-content').forEach(content => {
          content.classList.remove('active');
        });

        let chatContent = document.getElementById(`chat-${chatId}`);
        if (!chatContent) {
          chatContent = this.createChatContent(chatId);
          const chatInput = document.querySelector('.chat-input');
          this.chatMain.insertBefore(chatContent, chatInput);
        }
        chatContent.classList.add('active');

        // Actualiza estado de los botones de sala (solo si no es privado)
        if (!chatId.startsWith('private-')) {
          document.querySelectorAll('.rooms button').forEach(btn => {
            const btnRoomId = btn.getAttribute('data-room');
            btn.classList.toggle('active', btnRoomId === chatId);
          });
        }

        // Carga historial
        const messages = this.chatHistory.get(chatId) || [];
        const messagesContainer = chatContent.querySelector('.message-container');
        messagesContainer.innerHTML = '';
        messages.forEach(msg => this.appendMessageElement(msg, messagesContainer));

        this.scrollToBottom();
      }

      handleOpen() {
        this.connectionStatus.textContent = 'Conectado';
        this.connectionStatus.classList.add('connected');
        this.connectionStatus.classList.remove('disconnected');
        this.errorMessage.style.display = 'none';
      }

      handleClose() {
        this.connectionStatus.textContent = 'Desconectado...';
        this.connectionStatus.classList.remove('connected');
        this.connectionStatus.classList.add('disconnected');
      }

      handleError() {
        this.showError('Error de conexi√≥n');
      }

      handleMessage(event) {
        const data = JSON.parse(event.data);
        try {
          console.log('Mensaje recibido:', data);
          switch (data.type) {
            case 'welcome':
              if (data.users) {
                this.connectedUsers = new Set(data.users);
                this.updateUsersList(data.users);
              }
              this.addSystemMessage(data.message);
              break;

            case 'room_joined':
              if (data.users) {
                this.connectedUsers = new Set(data.users);
                this.updateUsersList(data.users);
              }
              break;

            case 'chat_message':
              if (data.room) {
                this.handleChatMessage(data);
              }
              break;

            case 'private_message':
              this.handlePrivateMessage(data);
              break;

            case 'user_joined':
              if (data.user && !this.connectedUsers.has(data.user)) {
                this.connectedUsers.add(data.user);
                this.updateUsersList([...this.connectedUsers]);
                this.addSystemMessage(`${data.user} se uni√≥ (${data.online_users} en l√≠nea)`);
              }
              break;

            case 'user_left':
              if (data.user && this.connectedUsers.has(data.user)) {
                this.connectedUsers.delete(data.user);
                this.updateUsersList([...this.connectedUsers]);
                this.addSystemMessage(`${data.user} sali√≥ (${data.online_users} en l√≠nea)`);
              }
              break;

            case 'error':
              this.showError(data.message);
              break;

            default:
              console.log('Tipo de mensaje no manejado:', data.type);
          }
        } catch (error) {
          console.error('Error procesando mensaje:', error);
          this.showError('Error al procesar el mensaje recibido');
        }
      }

      handleChatMessage(data) {
        const roomId = data.room;
        if (!this.availableRooms.includes(roomId)) {
          console.log(`Sala no v√°lida: ${roomId}`);
          return;
        }

        if (!this.chatHistory.has(roomId)) {
          this.chatHistory.set(roomId, []);
        }
        this.chatHistory.get(roomId).push(data);

        let chatContent = document.getElementById(`chat-${roomId}`);
        if (!chatContent) {
          chatContent = this.createChatContent(roomId);
          const chatInput = document.querySelector('.chat-input');
          this.chatMain.insertBefore(chatContent, chatInput);
        }
        const msgContainer = chatContent.querySelector('.message-container');
        this.appendMessageElement(data, msgContainer);

        if (data.user !== this.userId) {
          if (this.activeRoom !== roomId) {
            this.unreadCounts[roomId] = (this.unreadCounts[roomId] || 0) + 1;
            this.updateUnreadBadge(roomId);
          }
          const roomConfig = this.roomConfig[roomId];
          this.showNotification(
            `${roomConfig.emoji} Nuevo mensaje en ${roomConfig.name}`,
            `${data.user}: ${data.message}`,
            roomId
          );
        }

        if (this.activeRoom === roomId) {
          this.scrollToBottom();
        }
      }

      handlePrivateMessage(data) {
        const otherUser = data.from === this.userId ? data.to : data.from;
        const chatId = `private-${otherUser}`;

        this.appendMessageToChat(data, chatId);

        if (data.from !== this.userId) {
          if (this.activeRoom !== chatId) {
            const currentCount = this.unreadCounts.private.get(otherUser) || 0;
            this.unreadCounts.private.set(otherUser, currentCount + 1);
            this.updatePrivateUnreadCount(otherUser);
          }
          this.showNotification(
            `Mensaje privado de ${data.from}`,
            data.message,
            chatId
          );
        }
      }

      async sendMessage() {
        const message = this.messageInput.value.trim();
        if (!message) return;
        if (message.length > 1000) {
          this.showError('El mensaje es demasiado largo (m√°ximo 1000 caracteres)');
          return;
        }
        this.messageInput.value = '';

        const msgData = this.selectedUser
          ? {
              type: 'private_message',
              to: this.selectedUser,
              message: message,
              timestamp: Math.floor(Date.now() / 1000)
            }
          : {
              type: 'chat_message',
              room: this.room,
              message: message,
              timestamp: Math.floor(Date.now() / 1000)
            };

        try {
          await this.safeSend(msgData);
        } catch (error) {
          console.error('Error enviando mensaje:', error);
          this.showError('Error al enviar el mensaje. Por favor intenta de nuevo.');
          this.messageInput.value = message; // devolvemos el mensaje al input
        }
      }

      appendMessageToChat(data, chatId) {
        if (!this.chatHistory.has(chatId)) {
          this.chatHistory.set(chatId, []);
        }
        this.chatHistory.get(chatId).push(data);

        let chatContent = document.getElementById(`chat-${chatId}`);
        if (!chatContent) {
          chatContent = this.createChatContent(chatId);
          const chatInput = document.querySelector('.chat-input');
          this.chatMain.insertBefore(chatContent, chatInput);
        }

        const msgContainer = chatContent.querySelector('.message-container');
        this.appendMessageElement(data, msgContainer);

        if (this.activeRoom === chatId) {
          this.scrollToBottom();
        }
      }

      appendMessageElement(data, container) {
        const messageDiv = document.createElement('div');
        const isSentByMe = (data.user === this.userId);

        messageDiv.className = `message ${isSentByMe ? 'sent' : 'received'}`;
        if (data.type === 'private_message') {
          messageDiv.classList.add('private-message');
        }

        const userDiv = document.createElement('div');
        userDiv.className = 'user';
        userDiv.textContent = isSentByMe ? 'T√∫' : data.user;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'content';
        contentDiv.innerHTML = this.formatMessage(data.message);

        const timeDiv = document.createElement('div');
        timeDiv.className = 'time';
        const date = data.timestamp ? new Date(data.timestamp * 1000) : new Date();
        timeDiv.textContent = this.formatRelativeTime(date);

        messageDiv.appendChild(userDiv);
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(timeDiv);

        container.appendChild(messageDiv);
        this.scrollToBottom();
      }

      formatMessage(message) {
        message = message.replace(/[&<>"']/g, char => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[char]));

        message = message.replace(
          /(https?:\/\/[^\s]+)/g,
          '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
        );

        message = message
          .replace(/:\)/g, 'üòä')
          .replace(/:\(/g, 'üò¢')
          .replace(/:D/g, 'üòÉ')
          .replace(/;\)/g, 'üòâ');

        return message;
      }

      formatRelativeTime(date) {
        const now = new Date();
        const diff = now - date;
        if (diff < 60000) return 'hace un momento';
        if (diff < 3600000) return `hace ${Math.floor(diff/60000)} min`;
        if (diff < 86400000) return `hace ${Math.floor(diff/3600000)} h`;
        return date.toLocaleTimeString();
      }

      addSystemMessage(message) {
        const activeContent = document.querySelector('.chat-content.active');
        if (!activeContent) return;
        const msgContainer = activeContent.querySelector('.message-container');
        if (!msgContainer) return;

        const msgDiv = document.createElement('div');
        msgDiv.className = 'system-message';
        msgDiv.textContent = message;
        msgContainer.appendChild(msgDiv);

        this.scrollToBottom();
      }

      showError(msg) {
        this.errorMessage.textContent = msg;
        this.errorMessage.style.display = 'block';
        setTimeout(() => {
          this.errorMessage.style.display = 'none';
        }, 5000);
      }

      scrollToBottom() {
        const activeContent = document.querySelector('.chat-content.active');
        if (!activeContent) return;
        const chatMessages = activeContent.querySelector('.chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      updateUsersList(users) {
        this.usersList.innerHTML = '';
        const userArray = Array.isArray(users)
          ? users
          : (users instanceof Set)
            ? Array.from(users)
            : typeof users === 'number'
              ? []
              : [users];

        userArray.forEach(user => {
          if (user && user !== this.userId) {
            const userDiv = document.createElement('div');
            userDiv.className = `user-item ${this.selectedUser === user ? 'selected' : ''}`;
            userDiv.setAttribute('data-user', user);
            userDiv.innerHTML = `
              <span class="user-status"></span>
              <span class="user-name">${user}</span>
              <span class="unread-badge" style="display: none;"></span>
            `;
            userDiv.onclick = () => this.toggleUserSelection(user);
            this.usersList.appendChild(userDiv);

            const unreadCount = this.unreadCounts.private.get(user) || 0;
            if (unreadCount > 0) {
              this.updatePrivateUnreadCount(user);
            }
          }
        });

        const onlyMeOnline =
          userArray.length === 0 ||
          (userArray.length === 1 && userArray[0] === this.userId);

        if (onlyMeOnline) {
          const emptyState = document.createElement('div');
          emptyState.textContent = 'No hay otros usuarios conectados';
          emptyState.style.padding = '10px';
          this.usersList.appendChild(emptyState);
        }
      }

      toggleUserSelection(userId) {
        if (this.selectedUser === userId) {
          this.selectedUser = null;
          this.switchToChat(this.room);
          document.querySelectorAll('.rooms button').forEach(btn => {
            const roomId = btn.getAttribute('data-room');
            btn.classList.toggle('active', roomId === this.room);
          });
        } else {
          this.selectedUser = userId;
          this.unreadCounts.private.set(userId, 0);
          this.updatePrivateUnreadCount(userId);
          this.switchToChat(`private-${userId}`);

          document.querySelectorAll('.rooms button').forEach(btn => {
            btn.classList.remove('active');
          });
        }
        this.updateUsersList([...this.connectedUsers]);
        if (window.innerWidth < 768) {
          this.usersPanel.classList.remove('active');
        }
      }

      updateUnreadBadge(roomId) {
        if (!this.availableRooms.includes(roomId)) {
          console.log(`Intento de actualizar badge de sala no v√°lida: ${roomId}`);
          return;
        }
        const badge = document.getElementById(`unread-${roomId}`);
        if (!badge) {
          console.log(`No se encontr√≥ el badge para la sala: ${roomId}`);
          return;
        }
        const count = this.unreadCounts[roomId] || 0;
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'inline-flex';
          badge.classList.add('unread-count');

          badge.classList.remove('pulse');
          void badge.offsetWidth;
          badge.classList.add('pulse');
        } else {
          badge.textContent = '';
          badge.style.display = 'none';
        }
      }

      updatePrivateUnreadCount(userId) {
        const count = this.unreadCounts.private.get(userId) || 0;
        const userElement = this.usersList.querySelector(`.user-item[data-user="${userId}"]`);
        if (userElement) {
          const badge = userElement.querySelector('.unread-badge');
          if (badge) {
            if (count > 0) {
              badge.textContent = count > 99 ? '99+' : count;
              badge.style.display = 'inline-flex';
            } else {
              badge.style.display = 'none';
            }
          }
        }
      }

      async joinRoom(roomName) {
        try {
          await this.safeSend({
            type: 'join_room',
            room: roomName
          });
        } catch (error) {
          console.error('Error al unirse a la sala:', error);
          this.showError('Error al unirse a la sala');
        }
      }

      async changeRoom(newRoom) {
        if (!this.availableRooms.includes(newRoom)) {
          console.error(`Intento de cambiar a sala no v√°lida: ${newRoom}`);
          return;
        }

        this.selectedUser = null;
        this.updateUsersList([...this.connectedUsers]);

        const oldRoom = this.activeRoom;
        try {
          await this.safeSend({
            type: 'change_room',
            old_room: oldRoom,
            new_room: newRoom
          });

          this.activeRoom = newRoom;
          this.room = newRoom;

          this.unreadCounts[newRoom] = 0;
          this.updateUnreadBadge(newRoom);

          this.switchToChat(newRoom);
          this.addSystemMessage(`Cambiaste la sala a: ${newRoom}`);
        } catch (error) {
          console.error('Error al cambiar de sala:', error);
          this.showError('Error al cambiar de sala. Por favor intenta de nuevo.');
        }
      }

      async safeSend(data) {
        return new Promise((resolve, reject) => {
          const maxAttempts = 5;
          let attempts = 0;

          const tryToSend = () => {
            if (!this.ws) {
              reject(new Error('No hay conexi√≥n WebSocket'));
              return;
            }
            if (attempts >= maxAttempts) {
              reject(new Error('M√°ximo n√∫mero de intentos alcanzado'));
              return;
            }
            if (this.ws.readyState === WebSocket.OPEN) {
              try {
                this.ws.send(JSON.stringify(data));
                resolve();
              } catch (error) {
                reject(error);
              }
            } else if (this.ws.readyState === WebSocket.CONNECTING) {
              attempts++;
              setTimeout(tryToSend, 100);
            } else {
              reject(new Error('WebSocket no est√° disponible'));
            }
          };
          tryToSend();
        });
      }

      showNotification(title, body, roomId) {
        if (!("Notification" in window)) {
          console.log('Las notificaciones no est√°n soportadas en este navegador');
          return;
        }

        if (document.visibilityState === 'visible' && this.activeRoom === roomId) {
          return;
        }

        const showNotif = () => {
          try {
            const notification = new Notification(title, {
              body: body,
              icon: '/favicon.ico',
              tag: `chat-notification-${roomId}`,
              requireInteraction: false,
              silent: false
            });

            notification.onclick = () => {
              window.focus();
              if (roomId && this.availableRooms.includes(roomId)) {
                this.changeRoom(roomId);
              }
              notification.close();
            };

            setTimeout(() => notification.close(), 5000);

          } catch (error) {
            console.error('Error al mostrar notificaci√≥n:', error);
          }
        };

        if (Notification.permission === "granted") {
          showNotif();
        } else if (Notification.permission !== "denied") {
          Notification.requestPermission()
            .then(permission => {
              if (permission === "granted") {
                showNotif();
              }
            })
            .catch(error => {
              console.error('Error al solicitar permiso de notificaci√≥n:', error);
            });
        }
      }

      initializeUnreadCounters() {
        this.availableRooms.forEach(roomId => {
          const badge = document.getElementById(`unread-${roomId}`);
          if (badge) {
            badge.style.display = 'none';
            badge.classList.add('unread-count');
            badge.style.backgroundColor = 'var(--error-color)';
            badge.style.color = 'white';
            badge.style.borderRadius = '12px';
            badge.style.minWidth = '20px';
            badge.style.height = '20px';
            badge.style.padding = '0 6px';
            badge.style.fontSize = '0.75rem';
            badge.style.fontWeight = 'bold';
            badge.style.alignItems = 'center';
            badge.style.justifyContent = 'center';

            console.log(`Contador inicializado para ${roomId}`);
          } else {
            console.error(`No se encontr√≥ el badge para ${roomId}`);
          }
        });
      }
    }

    window.chatClient = new AdvancedChatClient();
    window.changeRoom = (room) => chatClient.changeRoom(room);
  </script>

</body>
</html>
